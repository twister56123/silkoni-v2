---
// Cart Drawer - Slide-in panel for cart with order form
---

<div
  x-data="{
    open: false,
    step: 'cart',
    form: {
      name: '',
      phone: '',
      city: '',
      cityRef: '',
      payment: 'cod',
      comment: ''
    },

    // City search
    citySearch: '',
    cities: [],
    showCityDropdown: false,
    isLoadingCities: false,
    citySearchTimeout: null,
    errors: {},

    async searchCities(query) {
      if (query.length < 2) {
        this.cities = [];
        this.showCityDropdown = false;
        return;
      }

      this.isLoadingCities = true;

      try {
        const response = await fetch('https://silkoni-api.bozhko-andrej.workers.dev/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            params: {
              modelName: 'Address',
              calledMethod: 'searchSettlements',
              methodProperties: {
                CityName: query,
                Limit: 10
              }
            }
          })
        });

        const data = await response.json();

        if (data.success && data.data && data.data[0]) {
          this.cities = data.data[0].Addresses || [];
        } else {
          this.cities = [];
        }

        this.showCityDropdown = this.cities.length > 0;
      } catch (error) {
        console.error('City search error:', error);
        this.cities = [];
      } finally {
        this.isLoadingCities = false;
      }
    },

    onCityInput(value) {
      this.citySearch = value;
      this.form.city = '';
      this.form.cityRef = '';

      clearTimeout(this.citySearchTimeout);
      this.citySearchTimeout = setTimeout(() => {
        this.searchCities(value);
      }, 300);
    },

    selectCity(city) {
      this.citySearch = city.Present;
      this.form.city = city.Present;
      this.form.cityRef = city.Ref;
      this.cities = [];
      this.showCityDropdown = false;
    },

    validate() {
      this.errors = {};
      if (!this.form.name.trim()) this.errors.name = 'Обовʼязкове поле';
      if (!this.form.phone.trim()) this.errors.phone = 'Обовʼязкове поле';
      if (!this.form.city.trim() || !this.form.cityRef) this.errors.city = 'Оберіть місто зі списку';
      return Object.keys(this.errors).length === 0;
    },

    submit() {
      if (!this.validate()) return;

      // For now just show success (Telegram + LiqPay integration later)
      this.step = 'success';

      // Clear cart after successful order
      setTimeout(() => {
        Alpine.store('cart').clear();
      }, 100);
    },

    reset() {
      this.step = 'cart';
      this.form = { name: '', phone: '', city: '', cityRef: '', payment: 'cod', comment: '' };
      this.errors = {};
      this.citySearch = '';
      this.cities = [];
      this.showCityDropdown = false;
      this.open = false;
    }
  }"
  @open-cart.window="open = true; step = 'cart'"
  @keydown.escape.window="open = false"
>
  <!-- Backdrop -->
  <div
    x-show="open"
    x-transition:enter="transition-opacity ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition-opacity ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="open = false"
    class="fixed inset-0 bg-black/50 z-50"
  ></div>

  <!-- Drawer Panel -->
  <div
    x-show="open"
    x-transition:enter="transition transform ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition transform ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    class="fixed right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl z-50 flex flex-col"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
      <h2 class="text-xl font-bold" x-text="step === 'success' ? 'Готово!' : 'Кошик'"></h2>
      <button
        type="button"
        @click="step === 'success' ? reset() : open = false"
        class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        aria-label="Закрити кошик"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- SUCCESS STATE -->
    <template x-if="step === 'success'">
      <div class="flex-1 flex flex-col items-center justify-center p-8 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </div>
        <h3 class="text-2xl font-bold mb-2">Дякуємо за замовлення!</h3>
        <p class="text-gray-600 mb-6">Ми зв'яжемося з вами найближчим часом для підтвердження.</p>
        <button
          type="button"
          @click="reset()"
          class="bg-black text-white px-8 py-3 rounded-xl font-medium hover:bg-gray-900 transition-colors"
        >
          Продовжити покупки
        </button>
      </div>
    </template>

    <!-- CART STATE -->
    <template x-if="step === 'cart'">
      <div class="flex-1 overflow-y-auto">
        <!-- Empty State -->
        <template x-if="$store.cart.items.length === 0">
          <div class="text-center py-12 px-4 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-300">
              <circle cx="8" cy="21" r="1"/>
              <circle cx="19" cy="21" r="1"/>
              <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/>
            </svg>
            <p>Кошик порожній</p>
            <button
              type="button"
              @click="open = false"
              class="mt-4 text-black underline hover:no-underline"
            >
              Продовжити покупки
            </button>
          </div>
        </template>

        <!-- Items + Form -->
        <template x-if="$store.cart.items.length > 0">
          <div class="p-4 space-y-6">
            <!-- Items List -->
            <div class="space-y-3">
              <template x-for="item in $store.cart.items" :key="item.id">
                <div class="flex gap-4 p-4 bg-gray-50 rounded-xl">
                  <div class="flex-1">
                    <h3 class="font-medium" x-text="item.product"></h3>
                    <p class="text-sm text-gray-600">
                      Колір: <span x-text="item.colorName"></span>
                    </p>
                    <p class="font-bold mt-1">
                      <span x-text="item.price"></span> ₴
                    </p>
                  </div>

                  <div class="flex flex-col items-end gap-2">
                    <button
                      type="button"
                      @click="$store.cart.remove(item.id)"
                      class="text-gray-400 hover:text-red-500 transition-colors"
                      aria-label="Видалити"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                      </svg>
                    </button>

                    <div class="flex items-center gap-2 bg-white rounded-lg border border-gray-200">
                      <button
                        type="button"
                        @click="$store.cart.updateQuantity(item.id, -1)"
                        class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-l-lg transition-colors"
                      >−</button>
                      <span class="w-8 text-center font-medium" x-text="item.quantity"></span>
                      <button
                        type="button"
                        @click="$store.cart.updateQuantity(item.id, 1)"
                        class="w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-r-lg transition-colors"
                      >+</button>
                    </div>
                  </div>
                </div>
              </template>
            </div>

            <!-- Order Form -->
            <div class="border-t border-gray-200 pt-6">
              <h3 class="font-bold mb-4">Дані для доставки</h3>

              <!-- Name -->
              <div class="mb-4">
                <label class="block text-sm font-medium mb-1" for="name">Ім'я *</label>
                <input
                  type="text"
                  id="name"
                  x-model="form.name"
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-shadow"
                  :class="errors.name ? 'border-red-500 ring-1 ring-red-500' : ''"
                  placeholder="Ваше ім'я"
                />
                <p x-show="errors.name" x-text="errors.name" class="text-red-500 text-sm mt-1"></p>
              </div>

              <!-- Phone -->
              <div class="mb-4">
                <label class="block text-sm font-medium mb-1" for="phone">Телефон *</label>
                <input
                  type="tel"
                  id="phone"
                  x-model="form.phone"
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-shadow"
                  :class="errors.phone ? 'border-red-500 ring-1 ring-red-500' : ''"
                  placeholder="+380 XX XXX XXXX"
                />
                <p x-show="errors.phone" x-text="errors.phone" class="text-red-500 text-sm mt-1"></p>
              </div>

              <!-- City -->
              <div class="mb-4 relative">
                <label class="block text-sm font-medium mb-1" for="city">Місто *</label>
                <input
                  type="text"
                  id="city"
                  x-model="citySearch"
                  @input="onCityInput($event.target.value)"
                  @focus="showCityDropdown = cities.length > 0"
                  @blur="setTimeout(() => showCityDropdown = false, 200)"
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-shadow"
                  :class="errors.city ? 'border-red-500 ring-1 ring-red-500' : ''"
                  placeholder="Ваше місто"
                />

                <!-- Loading spinner -->
                <div x-show="isLoadingCities" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                  <svg class="animate-spin h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>

                <!-- Dropdown -->
                <div
                  x-show="showCityDropdown"
                  x-transition:enter="transition ease-out duration-100"
                  x-transition:enter-start="opacity-0 scale-95"
                  x-transition:enter-end="opacity-100 scale-100"
                  x-transition:leave="transition ease-in duration-75"
                  x-transition:leave-start="opacity-100 scale-100"
                  x-transition:leave-end="opacity-0 scale-95"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-xl shadow-lg max-h-60 overflow-y-auto"
                >
                  <template x-for="city in cities" :key="city.Ref">
                    <div
                      @click="selectCity(city)"
                      class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                      x-text="city.Present"
                    ></div>
                  </template>
                </div>

                <p x-show="errors.city" x-text="errors.city" class="text-red-500 text-sm mt-1"></p>
              </div>

              <!-- Payment Method -->
              <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Спосіб оплати *</label>
                <div class="space-y-2">
                  <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors" :class="form.payment === 'cod' ? 'border-black bg-gray-50' : ''">
                    <input
                      type="radio"
                      name="payment"
                      value="cod"
                      x-model="form.payment"
                      class="w-4 h-4 text-black focus:ring-black"
                    />
                    <span>Накладений платіж (при отриманні)</span>
                  </label>
                  <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50 transition-colors" :class="form.payment === 'liqpay' ? 'border-black bg-gray-50' : ''">
                    <input
                      type="radio"
                      name="payment"
                      value="liqpay"
                      x-model="form.payment"
                      class="w-4 h-4 text-black focus:ring-black"
                    />
                    <span>Оплата карткою (LiqPay)</span>
                  </label>
                </div>
              </div>

              <!-- Comment -->
              <div class="mb-4">
                <label class="block text-sm font-medium mb-1" for="comment">Коментар</label>
                <textarea
                  id="comment"
                  x-model="form.comment"
                  rows="2"
                  class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-shadow resize-none"
                  placeholder="Додаткова інформація (необов'язково)"
                ></textarea>
              </div>
            </div>
          </div>
        </template>
      </div>
    </template>

    <!-- Footer with Total & Submit -->
    <template x-if="step === 'cart' && $store.cart.items.length > 0">
      <div class="border-t border-gray-200 p-4 space-y-4 bg-white">
        <div class="flex justify-between items-center text-lg">
          <span class="font-medium">Разом:</span>
          <span class="font-bold text-xl">
            <span x-text="$store.cart.totalPrice"></span> ₴
          </span>
        </div>

        <button
          type="button"
          @click="submit()"
          class="w-full bg-black text-white py-4 rounded-xl font-medium shadow-md hover:shadow-lg hover:bg-gray-900 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2"
        >
          <span x-text="form.payment === 'liqpay' ? 'Перейти до оплати' : 'Оформити замовлення'"></span>
        </button>
      </div>
    </template>
  </div>
</div>